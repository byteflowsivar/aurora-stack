#!/usr/bin/env node

/**
 * 02-setup-repository-labels.js
 * 
 * Script para configurar etiquetas (labels) en el repositorio de GitHub
 * 
 * PROP√ìSITO:
 * - Crear un sistema consistente de etiquetas para clasificar issues y PRs
 * - Establecer colores sem√°nticos que faciliten la identificaci√≥n visual
 * - Organizar el trabajo por tipo, prioridad, componente y estado
 * 
 * TIPOS DE ETIQUETAS:
 * - Tipo de trabajo: feature, bug, enhancement, documentation, etc.
 * - Prioridad: priority-high, priority-medium, priority-low
 * - Componente: por √°rea del sistema (auth, db, api, etc.)
 * - Estado: blocked, waiting-review, ready-to-test
 * - Esfuerzo: good-first-issue, epic
 * 
 * COLORES UTILIZADOS:
 * - Rojos: Bugs y problemas cr√≠ticos
 * - Azules: Features y mejoras
 * - Verdes: Documentaci√≥n y tareas completadas
 * - Naranjas: Prioridades y warnings
 * - P√∫rpuras: Componentes del sistema
 * 
 * PREREQUISITOS:
 * - GitHub CLI instalado (gh)
 * - Token de acceso con permisos de repositorio
 * - Repositorio ya creado
 */

const { execSync } = require('child_process');
const { join } = require('path');

// Cargar variables de entorno desde .env
require('dotenv').config({ path: join(__dirname, '.env') });

// Configuraci√≥n del repositorio
const CONFIG = {
  // Variables cargadas desde .env
  REPO_OWNER: process.env.GITHUB_OWNER,
  REPO_NAME: process.env.REPO_NAME || 'aurora-stack',
  OWNER_TYPE: process.env.GITHUB_OWNER_TYPE || 'user',
  
  // Etiquetas a crear/actualizar
  LABELS: [
    // === TIPOS DE TRABAJO ===
    {
      name: 'type: feature',
      color: '0052cc',
      description: 'Nueva funcionalidad o caracter√≠stica'
    },
    {
      name: 'type: bug',
      color: 'd73a4a',
      description: 'Error o problema que necesita correcci√≥n'
    },
    {
      name: 'type: enhancement',
      color: '0e8a16',
      description: 'Mejora a funcionalidad existente'
    },
    {
      name: 'type: documentation',
      color: '006b75',
      description: 'Documentaci√≥n y gu√≠as'
    },
    {
      name: 'type: refactor',
      color: 'fbca04',
      description: 'Refactorizaci√≥n de c√≥digo sin cambios funcionales'
    },
    {
      name: 'type: test',
      color: '1d76db',
      description: 'Pruebas unitarias, integraci√≥n o e2e'
    },
    {
      name: 'type: infrastructure',
      color: '5319e7',
      description: 'DevOps, CI/CD, configuraci√≥n de infraestructura'
    },

    // === PRIORIDADES ===
    {
      name: 'priority: high',
      color: 'b60205',
      description: 'üî• Prioridad alta - Urgente'
    },
    {
      name: 'priority: medium',
      color: 'ff9f1c',
      description: '‚ö° Prioridad media - Importante'
    },
    {
      name: 'priority: low',
      color: 'ffdfba',
      description: 'üìã Prioridad baja - Cuando sea posible'
    },

    // === COMPONENTES DEL SISTEMA ===
    {
      name: 'component: keycloak',
      color: '8b5cf6',
      description: 'Keycloak, autenticaci√≥n y autorizaci√≥n'
    },
    {
      name: 'component: database',
      color: '7c3aed',
      description: 'PostgreSQL, modelos de datos, migraciones'
    },
    {
      name: 'component: api',
      color: '6366f1',
      description: 'APIs REST, GraphQL, servicios backend'
    },
    {
      name: 'component: frontend',
      color: '3b82f6',
      description: 'Interfaz de usuario, componentes React/Vue'
    },
    {
      name: 'component: docker',
      color: '0ea5e9',
      description: 'Docker, containerizaci√≥n, orquestaci√≥n'
    },
    {
      name: 'component: networking',
      color: '06b6d4',
      description: 'Redes, nginx, load balancers'
    },

    // === ESTADOS DE TRABAJO ===
    {
      name: 'status: blocked',
      color: 'e11d48',
      description: 'üö´ Bloqueado - No puede continuar'
    },
    {
      name: 'status: waiting-review',
      color: 'f59e0b',
      description: 'üëÄ Esperando revisi√≥n de c√≥digo'
    },
    {
      name: 'status: ready-to-test',
      color: '10b981',
      description: 'üß™ Listo para pruebas'
    },
    {
      name: 'status: in-progress',
      color: '3b82f6',
      description: '‚ö° En desarrollo activo'
    },

    // === ESFUERZO Y COMPLEJIDAD ===
    {
      name: 'effort: epic',
      color: '6b21a8',
      description: 'üèîÔ∏è Epic - Tarea grande, dividir en subtareas'
    },
    {
      name: 'effort: good-first-issue',
      color: '22c55e',
      description: 'üå± Buena primera contribuci√≥n - Para nuevos dev'
    },
    {
      name: 'effort: quick-win',
      color: '84cc16',
      description: '‚ö° Victoria r√°pida - Menos de 2 horas'
    },

    // === ETIQUETAS ESPECIALES ===
    {
      name: 'breaking-change',
      color: 'dc2626',
      description: 'üí• Cambio que rompe compatibilidad'
    },
    {
      name: 'security',
      color: 'ef4444',
      description: 'üîí Relacionado con seguridad'
    },
    {
      name: 'performance',
      color: 'f97316',
      description: 'üöÄ Mejora de rendimiento'
    },
    {
      name: 'dependencies',
      color: '0284c7',
      description: 'üì¶ Actualizaci√≥n de dependencias'
    },
    {
      name: 'question',
      color: 'd946ef',
      description: '‚ùì Pregunta o discusi√≥n'
    },
    {
      name: 'wontfix',
      color: '6b7280',
      description: 'üö´ No se va a arreglar'
    },
    {
      name: 'duplicate',
      color: '6b7280',
      description: 'üëØ Issue duplicado'
    }
  ]
};

/**
 * Ejecuta un comando de GitHub CLI
 * @param {string} command - Comando a ejecutar
 * @returns {string} - Salida del comando
 */
function runGhCommand(command) {
  try {
    const result = execSync(command, { encoding: 'utf-8' });
    return result.trim();
  } catch (error) {
    console.error(`Error ejecutando comando: ${command}`);
    console.error(error.message);
    throw error;
  }
}

/**
 * Verifica si GitHub CLI est√° instalado y autenticado
 */
function checkPrerequisites() {
  console.log('üîç Verificando prerequisitos...');
  
  // Verificar que las variables de entorno est√©n configuradas
  if (!CONFIG.REPO_OWNER) {
    console.error('‚ùå GITHUB_OWNER no est√° configurado en .env');
    console.error('   Copia .env.example a .env y config√∫ralo');
    console.error('   Luego ejecuta: node 00-validate-permissions.js');
    process.exit(1);
  }
  
  console.log(`‚úÖ Configuraci√≥n cargada: ${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}`);
}

/**
 * Obtiene todas las etiquetas existentes del repositorio
 * @returns {Array} - Lista de etiquetas existentes
 */
function getExistingLabels() {
  console.log('üîç Obteniendo etiquetas existentes...');
  
  try {
    const command = `gh api repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/labels`;
    const result = JSON.parse(runGhCommand(command));
    
    console.log(`‚úÖ Encontradas ${result.length} etiquetas existentes`);
    return result.map(label => label.name);
  } catch (error) {
    console.warn('‚ö†Ô∏è  No se pudieron obtener etiquetas existentes');
    return [];
  }
}

/**
 * Crea o actualiza una etiqueta
 * @param {object} label - Configuraci√≥n de la etiqueta
 * @param {Array} existingLabels - Etiquetas existentes
 */
function createOrUpdateLabel(label, existingLabels) {
  const exists = existingLabels.includes(label.name);
  
  try {
    if (exists) {
      // Actualizar etiqueta existente
      const command = `gh api --method PATCH repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/labels/${encodeURIComponent(label.name)} -f name="${label.name}" -f color="${label.color}" -f description="${label.description}"`;
      runGhCommand(command);
      console.log(`üîÑ Actualizada: ${label.name}`);
    } else {
      // Crear nueva etiqueta
      const command = `gh api --method POST repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/labels -f name="${label.name}" -f color="${label.color}" -f description="${label.description}"`;
      runGhCommand(command);
      console.log(`‚úÖ Creada: ${label.name}`);
    }
  } catch (error) {
    // Si el error es 404 al actualizar, la etiqueta fue eliminada, crear una nueva
    if (error.message.includes('404') || error.message.includes('Not Found')) {
      try {
        console.log(`‚ÑπÔ∏è  Etiqueta '${label.name}' no existe, creando nueva...`);
        const command = `gh api --method POST repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/labels -f name="${label.name}" -f color="${label.color}" -f description="${label.description}"`;
        runGhCommand(command);
        console.log(`‚úÖ Creada: ${label.name}`);
      } catch (createError) {
        console.error(`‚ùå Error creando etiqueta '${label.name}': ${createError.message}`);
      }
    } else {
      console.error(`‚ùå Error con etiqueta '${label.name}': ${error.message}`);
    }
  }
}

/**
 * Elimina etiquetas por defecto que no necesitamos
 */
function removeDefaultLabels() {
  const defaultLabelsToRemove = [
    'bug',           // La reemplazamos con 'type: bug' 
    'documentation', // La reemplazamos con 'type: documentation'
    'enhancement',   // La reemplazamos con 'type: enhancement'
    'good first issue', // La reemplazamos con 'effort: good-first-issue'
    'help wanted',
    'invalid'
  ];

  // NO eliminamos 'duplicate', 'question', 'wontfix' porque las vamos a redefinir
  const customLabelsToRedefine = ['duplicate', 'question', 'wontfix'];

  console.log('üóëÔ∏è  Eliminando etiquetas por defecto innecesarias...');

  defaultLabelsToRemove.forEach(labelName => {
    try {
      const command = `gh api --method DELETE repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/labels/${encodeURIComponent(labelName)}`;
      runGhCommand(command);
      console.log(`üóëÔ∏è  Eliminada: ${labelName}`);
    } catch (error) {
      // No importa si la etiqueta no existe
      console.log(`‚ÑπÔ∏è  Etiqueta '${labelName}' no existe o ya fue eliminada`);
    }
  });

  console.log(`‚ÑπÔ∏è  Manteniendo ${customLabelsToRedefine.join(', ')} para redefinir con nuevos colores/descripciones`);
}

/**
 * Genera un reporte de las etiquetas creadas
 */
function generateReport() {
  console.log('\nüìä REPORTE DE ETIQUETAS CONFIGURADAS\n');
  
  const categories = [
    { title: 'üîß TIPOS DE TRABAJO', filter: name => name.startsWith('type:') },
    { title: '‚≠ê PRIORIDADES', filter: name => name.startsWith('priority:') },
    { title: 'üèóÔ∏è COMPONENTES', filter: name => name.startsWith('component:') },
    { title: 'üìã ESTADOS', filter: name => name.startsWith('status:') },
    { title: 'üí™ ESFUERZO', filter: name => name.startsWith('effort:') },
    { title: 'üéØ ESPECIALES', filter: name => !name.includes(':') }
  ];

  categories.forEach(category => {
    console.log(category.title);
    const labels = CONFIG.LABELS.filter(label => category.filter(label.name));
    labels.forEach(label => {
      console.log(`   ${label.name} - ${label.description}`);
    });
    console.log('');
  });
}

/**
 * Funci√≥n principal
 */
function main() {
  console.log('üè∑Ô∏è  Iniciando configuraci√≥n de etiquetas para GitHub Repository');
  console.log(`üìÅ Repositorio: ${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}\n`);
  
  // Verificar prerequisitos
  checkPrerequisites();
  
  // Eliminar etiquetas por defecto PRIMERO
  removeDefaultLabels();
  
  // Obtener etiquetas existentes DESPU√âS de eliminar las por defecto
  const existingLabels = getExistingLabels();
  
  // Crear/actualizar etiquetas
  console.log('\nüè∑Ô∏è  Configurando etiquetas personalizadas...');
  CONFIG.LABELS.forEach(label => {
    createOrUpdateLabel(label, existingLabels);
  });
  
  // Generar reporte
  generateReport();
  
  console.log('‚úÖ ¬°Configuraci√≥n de etiquetas completada!');
  console.log('\nüéØ Pr√≥ximos pasos:');
  console.log('   1. Ejecutar: node 03-create-sample-issues.js');
  console.log('   2. Usar las etiquetas al crear issues y PRs');
  console.log('   3. Configurar plantillas de issues con etiquetas predeterminadas');
}

// Ejecutar solo si es llamado directamente
if (require.main === module) {
  main();
}

module.exports = { CONFIG, runGhCommand, checkPrerequisites };